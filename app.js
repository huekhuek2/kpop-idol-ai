// ===== TRANSLATIONS =====
const translations = {
    ko: {
        badge: 'AI í¼ìŠ¤ë„ ì»¬ëŸ¬ ì§„ë‹¨',
        title: 'ë‚˜ì™€ ë‹®ì€ K-POP ì•„ì´ëŒì€?',
        subtitle: 'ì‚¬ì§„ í•œ ì¥ìœ¼ë¡œ í¼ìŠ¤ë„ ì»¬ëŸ¬ ì§„ë‹¨ê³¼ ë‹®ì€ê¼´ ì•„ì´ëŒì„ ì°¾ì•„ë³´ì„¸ìš”',
        uploadIcon: 'ğŸ“¸',
        uploadText: '<span>ì‚¬ì§„ì„ ì—…ë¡œë“œ</span>í•˜ê±°ë‚˜ ì—¬ê¸°ì— ëŒì–´ë†“ìœ¼ì„¸ìš”',
        uploadHint: 'JPG, PNG (ìµœëŒ€ 10MB)',
        male: 'ğŸ‘¨ ë‚¨ì ì•„ì´ëŒ',
        female: 'ğŸ‘© ì—¬ì ì•„ì´ëŒ',
        analyzeBtn: 'âœ¨ AI ë¶„ì„ ì‹œì‘í•˜ê¸°',
        loadingText: 'AIê°€ ì–¼êµ´ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...',
        resultTitle: 'í¼ìŠ¤ë„ ì»¬ëŸ¬ ì§„ë‹¨ ê²°ê³¼',
        resultSubtitle: 'AIê°€ ë¶„ì„í•œ ë‹¹ì‹ ì˜ ìŠ¤íƒ€ì¼ ë¦¬í¬íŠ¸',
        bestColors: 'ë² ìŠ¤íŠ¸ ì»¬ëŸ¬',
        avoidColors: 'í”¼í•´ì•¼ í•  ì»¬ëŸ¬',
        idolTitle: 'ë‹®ì€ê¼´ K-POP ì•„ì´ëŒ TOP 3',
        featureFace: 'ì–¼êµ´í˜•',
        featureEye: 'ëˆˆ ëª¨ì–‘',
        featureNose: 'ì½” ëª¨ì–‘',
        featureLip: 'ì…ìˆ  ëª¨ì–‘',
        featureVibe: 'ì „ì²´ ë¶„ìœ„ê¸°',
        ctaBtn: 'ğŸ¥ ì´ ì•„ì´ëŒì²˜ëŸ¼ ë˜ê³  ì‹¶ë‹¤ë©´? AI ì„±í˜• ìƒë‹´ì†Œì—ì„œ ë¬´ë£Œ ê²¬ì  ë°›ê¸°',
        shareTwitter: 'ğ• íŠ¸ìœ„í„° ê³µìœ ',
        saveImage: 'ğŸ“· ê²°ê³¼ ì €ì¥í•˜ê¸°',
        copyLink: 'ğŸ”— ë§í¬ ë³µì‚¬',
        copied: 'âœ… ë³µì‚¬ë¨!',
        tweetText: 'ë‚˜ë‘ ë‹®ì€ K-POP ì•„ì´ëŒì€ {idol}! ë‹¹ì‹ ì˜ í¼ìŠ¤ë„ ì»¬ëŸ¬ì™€ ë‹®ì€ê¼´ ì•„ì´ëŒì„ í™•ì¸í•´ë³´ì„¸ìš” âœ¨ #KPOP #ì•„ì´ëŒë‹®ì€ê¼´ #í¼ìŠ¤ë„ì»¬ëŸ¬',
        columnTitle: 'K-Beauty ìŠ¤íƒ€ì¼ë§ ê°€ì´ë“œ',
        footerText: 'Â© 2026 K-POP Idol AI. All rights reserved.',
        errorMsg: 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        noImage: 'ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.',
        retryBtn: 'ë‹¤ì‹œ ë¶„ì„í•˜ê¸°',
        optimizingText: 'ğŸ”„ ì´ë¯¸ì§€ ìµœì í™” ì¤‘...',
    },
    en: {
        badge: 'AI Personal Color Diagnosis',
        title: 'Which K-POP Idol Do You Look Like?',
        subtitle: 'Discover your personal color and K-POP idol lookalike with just one photo',
        uploadIcon: 'ğŸ“¸',
        uploadText: '<span>Upload a photo</span> or drag and drop here',
        uploadHint: 'JPG, PNG (max 10MB)',
        male: 'ğŸ‘¨ Male Idol',
        female: 'ğŸ‘© Female Idol',
        analyzeBtn: 'âœ¨ Start AI Analysis',
        loadingText: 'AI is analyzing your face...',
        resultTitle: 'Personal Color Diagnosis Result',
        resultSubtitle: 'Your AI-powered style report',
        bestColors: 'Best Colors',
        avoidColors: 'Colors to Avoid',
        idolTitle: 'Top 3 Lookalike K-POP Idols',
        featureFace: 'Face Shape',
        featureEye: 'Eye Shape',
        featureNose: 'Nose Shape',
        featureLip: 'Lip Shape',
        featureVibe: 'Overall Vibe',
        ctaBtn: 'ğŸ¥ Want to look like this idol? Get a free AI consultation',
        shareTwitter: 'ğ• Share on X',
        saveImage: 'ğŸ“· Save Result',
        copyLink: 'ğŸ”— Copy Link',
        copied: 'âœ… Copied!',
        tweetText: 'My K-POP idol lookalike is {idol}! Find your personal color and idol match âœ¨ #KPOP #IdolLookalike #PersonalColor',
        columnTitle: 'K-Beauty Styling Guide',
        footerText: 'Â© 2026 K-POP Idol AI. All rights reserved.',
        errorMsg: 'An error occurred during analysis. Please try again.',
        noImage: 'Please upload a photo first.',
        retryBtn: 'Analyze Again',
        optimizingText: 'ğŸ”„ Optimizing image...',
    },
    ja: {
        badge: 'AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­',
        title: 'ã‚ãªãŸã«ä¼¼ã¦ã„ã‚‹K-POPã‚¢ã‚¤ãƒ‰ãƒ«ã¯ï¼Ÿ',
        subtitle: 'å†™çœŸä¸€æšã§ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­ã¨ãã£ãã‚Šã‚¢ã‚¤ãƒ‰ãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†',
        uploadIcon: 'ğŸ“¸',
        uploadText: '<span>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>ã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—',
        uploadHint: 'JPG, PNGï¼ˆæœ€å¤§10MBï¼‰',
        male: 'ğŸ‘¨ ç”·æ€§ã‚¢ã‚¤ãƒ‰ãƒ«',
        female: 'ğŸ‘© å¥³æ€§ã‚¢ã‚¤ãƒ‰ãƒ«',
        analyzeBtn: 'âœ¨ AIåˆ†æã‚’é–‹å§‹ã™ã‚‹',
        loadingText: 'AIãŒé¡”ã‚’åˆ†æã—ã¦ã„ã¾ã™...',
        resultTitle: 'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼è¨ºæ–­çµæœ',
        resultSubtitle: 'AIãŒåˆ†æã—ãŸã‚ãªãŸã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒ¬ãƒãƒ¼ãƒˆ',
        bestColors: 'ãƒ™ã‚¹ãƒˆã‚«ãƒ©ãƒ¼',
        avoidColors: 'é¿ã‘ã‚‹ã¹ãã‚«ãƒ©ãƒ¼',
        idolTitle: 'ãã£ãã‚ŠK-POPã‚¢ã‚¤ãƒ‰ãƒ« TOP 3',
        featureFace: 'é¡”ã®å½¢',
        featureEye: 'ç›®ã®å½¢',
        featureNose: 'é¼»ã®å½¢',
        featureLip: 'å”‡ã®å½¢',
        featureVibe: 'å…¨ä½“ã®é›°å›²æ°—',
        ctaBtn: 'ğŸ¥ ã“ã®ã‚¢ã‚¤ãƒ‰ãƒ«ã®ã‚ˆã†ã«ãªã‚ŠãŸã„ï¼ŸAIç¾å®¹ç›¸è«‡ã§ç„¡æ–™è¦‹ç©ã‚‚ã‚Š',
        shareTwitter: 'ğ• Xã§ã‚·ã‚§ã‚¢',
        saveImage: 'ğŸ“· çµæœã‚’ä¿å­˜',
        copyLink: 'ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼',
        copied: 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼',
        tweetText: 'ç§ã«ä¼¼ã¦ã„ã‚‹K-POPã‚¢ã‚¤ãƒ‰ãƒ«ã¯{idol}ï¼ã‚ãªãŸã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼ã¨ãã£ãã‚Šã‚¢ã‚¤ãƒ‰ãƒ«ã‚’ç¢ºèªã—ã¦ã¿ã¦ âœ¨ #KPOP #ã‚¢ã‚¤ãƒ‰ãƒ«ãã£ãã‚Š #ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼',
        columnTitle: 'K-Beautyã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚¬ã‚¤ãƒ‰',
        footerText: 'Â© 2026 K-POP Idol AI. All rights reserved.',
        errorMsg: 'åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        noImage: 'å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚',
        retryBtn: 'ã‚‚ã†ä¸€åº¦åˆ†æã™ã‚‹',
        optimizingText: 'ğŸ”„ ç”»åƒã‚’æœ€é©åŒ–ã—ã¦ã„ã¾ã™...',
    }
};

// ===== STATE =====
let currentLang = 'ko';
let currentGender = 'male';
let uploadedImage = null;
let analysisResult = null;

// ===== DOM READY =====
document.addEventListener('DOMContentLoaded', () => {
    setupLanguageToggle();
    setupUpload();
    setupGenderSelector();
    setupAnalyzeButton();
    setupColumnTabs();
    setLanguage('ko');
});

// ===== LANGUAGE =====
function setupLanguageToggle() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });
}

function setLanguage(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
    const t = translations[lang];
    // Update all translatable elements
    const map = {
        'hero-badge': 'badge', 'hero-title': 'title', 'hero-subtitle': 'subtitle',
        'upload-text': 'uploadText', 'upload-hint': 'uploadHint',
        'analyze-btn': 'analyzeBtn', 'loading-text': 'loadingText',
        'result-title': 'resultTitle', 'result-subtitle': 'resultSubtitle',
        'best-colors-label': 'bestColors', 'avoid-colors-label': 'avoidColors',
        'idol-title': 'idolTitle',
        'feature-face-label': 'featureFace', 'feature-eye-label': 'featureEye',
        'feature-nose-label': 'featureNose', 'feature-lip-label': 'featureLip',
        'feature-vibe-label': 'featureVibe',
        'cta-btn': 'ctaBtn',
        'share-twitter': 'shareTwitter', 'save-image': 'saveImage',
        'copy-link': 'copyLink',
        'column-title': 'columnTitle', 'footer-text': 'footerText',
        'retry-btn': 'retryBtn',
    };
    for (const [id, key] of Object.entries(map)) {
        const el = document.getElementById(id);
        if (el) {
            if (key === 'uploadText') el.innerHTML = t[key];
            else el.textContent = t[key];
        }
    }
    // Gender buttons
    const maleBtn = document.getElementById('male-btn');
    const femaleBtn = document.getElementById('female-btn');
    if (maleBtn) maleBtn.textContent = t.male;
    if (femaleBtn) femaleBtn.textContent = t.female;

    // Column content
    document.querySelectorAll('.column-lang-content').forEach(el => {
        el.style.display = 'none';
    });
    const activeColumn = document.getElementById(`column-${lang}`);
    if (activeColumn) activeColumn.style.display = 'block';
    document.querySelectorAll('.column-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.lang === lang);
    });
}

// ===== UPLOAD =====
function setupUpload() {
    const area = document.getElementById('upload-area');
    const input = document.getElementById('file-input');
    const placeholder = document.getElementById('upload-placeholder');
    const preview = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    const removeBtn = document.getElementById('preview-remove');

    area.addEventListener('click', (e) => {
        if (!area.classList.contains('has-image')) input.click();
    });
    area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('dragover'); });
    area.addEventListener('dragleave', () => area.classList.remove('dragover'));
    area.addEventListener('drop', (e) => {
        e.preventDefault(); area.classList.remove('dragover');
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });
    input.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });
    removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        clearImage();
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) return;
        if (file.size > 10 * 1024 * 1024) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImage = e.target.result;
            previewImg.src = uploadedImage;
            placeholder.style.display = 'none';
            preview.style.display = 'block';
            area.classList.add('has-image');
        };
        reader.readAsDataURL(file);
    }

    function clearImage() {
        uploadedImage = null;
        input.value = '';
        placeholder.style.display = 'block';
        preview.style.display = 'none';
        area.classList.remove('has-image');
    }
}

// ===== GENDER =====
function setupGenderSelector() {
    document.querySelectorAll('.gender-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentGender = btn.dataset.gender;
            document.querySelectorAll('.gender-btn').forEach(b => b.classList.toggle('active', b.dataset.gender === currentGender));
        });
    });
}

// ===== IMAGE COMPRESSION =====
function compressImage(dataUrl, maxSize = 1024, quality = 0.75) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            let { width, height } = img;
            // Resize if larger than maxSize
            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = Math.round(height * (maxSize / width));
                    width = maxSize;
                } else {
                    width = Math.round(width * (maxSize / height));
                    height = maxSize;
                }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const compressed = canvas.toDataURL('image/jpeg', quality);
            resolve(compressed);
        };
        img.onerror = reject;
        img.src = dataUrl;
    });
}

// ===== ANALYZE =====
function setupAnalyzeButton() {
    const btn = document.getElementById('analyze-btn');
    const retryBtn = document.getElementById('retry-btn');
    btn.addEventListener('click', startAnalysis);
    if (retryBtn) retryBtn.addEventListener('click', () => {
        document.getElementById('result-section').classList.remove('show');
        document.querySelector('.share-section').style.display = 'none';
        startAnalysis();
    });
}

async function startAnalysis() {
    const t = translations[currentLang];
    if (!uploadedImage) {
        alert(t.noImage);
        return;
    }
    const btn = document.getElementById('analyze-btn');
    const loading = document.getElementById('loading-section');
    const loadingText = document.getElementById('loading-text');
    const resultSection = document.getElementById('result-section');

    btn.disabled = true;
    resultSection.classList.remove('show');
    loading.classList.add('show');

    try {
        // Step 1: Compress image
        loadingText.textContent = t.optimizingText;
        const compressedImage = await compressImage(uploadedImage, 1024, 0.75);

        // Step 2: Send to API
        loadingText.textContent = t.loadingText;
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: compressedImage,
                gender: currentGender,
                lang: currentLang
            })
        });

        if (!response.ok) throw new Error('API error');
        analysisResult = await response.json();
        renderResult(analysisResult);
    } catch (error) {
        console.error(error);
        alert(t.errorMsg);
    } finally {
        btn.disabled = false;
        loading.classList.remove('show');
    }
}

function renderResult(data) {
    // Personal Color
    document.getElementById('pc-season').textContent = data.personalColor.season;
    document.getElementById('pc-subtype').textContent = data.personalColor.subtype;
    document.getElementById('pc-desc').textContent = data.personalColor.description;

    // Color palettes
    const bestContainer = document.getElementById('best-colors');
    const avoidContainer = document.getElementById('avoid-colors');
    bestContainer.innerHTML = '';
    avoidContainer.innerHTML = '';
    (data.personalColor.bestColors || []).forEach(c => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch';
        sw.style.background = c;
        sw.title = c;
        bestContainer.appendChild(sw);
    });
    (data.personalColor.avoidColors || []).forEach(c => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch';
        sw.style.background = c;
        sw.title = c;
        avoidContainer.appendChild(sw);
    });

    // Idol matches
    const idolList = document.getElementById('idol-list');
    idolList.innerHTML = '';
    (data.idolMatches || []).forEach((idol, i) => {
        const item = document.createElement('div');
        item.className = 'idol-item';
        item.innerHTML = `
      <div class="idol-rank">${i + 1}</div>
      <div class="idol-info">
        <div class="idol-name">${idol.name}</div>
        <div class="idol-group">${idol.group}</div>
        <div class="idol-reason">${idol.matchReason}</div>
      </div>
      <div class="idol-match-pct">${idol.matchPercentage}%</div>
    `;
        idolList.appendChild(item);
    });

    // Compliment
    document.getElementById('compliment-text').textContent = data.compliment;

    // Facial features
    if (data.facialFeatures) {
        const ff = data.facialFeatures;
        document.getElementById('feature-face-value').textContent = ff.faceShape || '';
        document.getElementById('feature-eye-value').textContent = ff.eyeShape || '';
        document.getElementById('feature-nose-value').textContent = ff.noseShape || '';
        document.getElementById('feature-lip-value').textContent = ff.lipShape || '';
        document.getElementById('feature-vibe-value').textContent = ff.overallVibe || '';
    }

    // Show result
    document.getElementById('result-section').classList.add('show');
    document.querySelector('.share-section').style.display = 'flex';
    document.getElementById('result-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Setup share
    setupShareButtons(data);
}

// ===== SHARE =====
function setupShareButtons(data) {
    const t = translations[currentLang];
    const idolName = data.idolMatches?.[0]?.name || 'K-POP Idol';

    // Twitter
    document.getElementById('share-twitter').onclick = () => {
        const text = t.tweetText.replace('{idol}', idolName);
        const url = encodeURIComponent(window.location.href);
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`, '_blank');
    };

    // Save Image
    document.getElementById('save-image').onclick = async () => {
        try {
            const card = document.getElementById('result-card');
            const canvas = await html2canvas(card, {
                backgroundColor: '#0a0a0f',
                scale: 2,
                useCORS: true,
            });
            const link = document.createElement('a');
            link.download = 'kpop-idol-result.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch (e) {
            console.error('Image save failed:', e);
        }
    };

    // Copy Link
    document.getElementById('copy-link').onclick = async () => {
        try {
            await navigator.clipboard.writeText(window.location.href);
            const btn = document.getElementById('copy-link');
            const original = btn.textContent;
            btn.textContent = t.copied;
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = original; btn.classList.remove('copied'); }, 2000);
        } catch (e) {
            console.error('Copy failed:', e);
        }
    };
}

// ===== COLUMN TABS =====
function setupColumnTabs() {
    document.querySelectorAll('.column-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const lang = tab.dataset.lang;
            document.querySelectorAll('.column-tab').forEach(t => t.classList.toggle('active', t.dataset.lang === lang));
            document.querySelectorAll('.column-lang-content').forEach(c => c.style.display = 'none');
            document.getElementById(`column-${lang}`).style.display = 'block';
        });
    });
}
